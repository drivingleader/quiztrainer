<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Traffic Master - Text Pro</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&family=JetBrains+Mono:wght@400;700&display=swap" rel="stylesheet">
    
    <style>
        /* CORE LAYOUT */
        body { background-color: #020617; color: #e2e8f0; font-family: 'Inter', sans-serif; height: 100vh; overflow: hidden; display: flex; flex-direction: column; }
        .app-section { display: none; height: 100%; width: 100%; flex-direction: column; }
        .app-section.active { display: flex; }

        /* MENU CARDS */
        .menu-card { 
            transition: all 0.2s cubic-bezier(0.25, 0.46, 0.45, 0.94); 
            cursor: pointer; position: relative; overflow: hidden; 
            border: 1px solid rgba(30, 41, 59, 0.5);
        }
        .menu-card:active { transform: scale(0.98); background-color: #1e293b; }
        .menu-card:hover { border-color: rgba(59, 130, 246, 0.5); }

        /* FILTER CHIPS */
        .filter-chip { 
            font-size: 0.75rem; padding: 10px 12px; border-radius: 8px; 
            background: #0f172a; border: 1px solid #1e293b; color: #64748b; 
            cursor: pointer; transition: all 0.15s; text-align: left;
            display: flex; align-items: center; justify-content: space-between;
            margin-bottom: 6px; user-select: none;
        }
        .filter-chip.selected { 
            background: #1e40af; border-color: #3b82f6; color: white; 
            box-shadow: 0 4px 12px rgba(37, 99, 235, 0.2); 
        }
        .filter-count { font-size: 0.65rem; opacity: 0.6; font-weight: bold; background: rgba(0,0,0,0.2); padding: 2px 6px; border-radius: 4px; }

        /* QUIZ TYPOGRAPHY */
        .prefix-text { color: #94a3b8; font-size: 0.95rem; margin-bottom: 4px; display: block; font-weight: 500; }
        .highlight-text { 
            color: #ffffff; font-weight: 800; line-height: 1.4; font-size: 1.35rem; 
            display: block; margin: 0.5rem 0; 
            text-shadow: 0 2px 10px rgba(0,0,0,0.5);
        }
        
        /* CODE BREAKER */
        .breaker-font { font-family: 'JetBrains Mono', monospace; color: #4ade80; background-color: #000000; }
        .slot { 
            border-bottom: 2px solid #333; min-width: 24px; height: 40px; 
            display: flex; justify-content: center; align-items: center; 
            font-size: 1.2rem; font-weight: bold; margin: 0 2px; 
            text-transform: uppercase; transition: border-color 0.2s;
        }
        .slot.active { border-color: #4ade80; background: rgba(74, 222, 128, 0.1); }
        .slot.filled { color: white; border-color: #94a3b8; }
        .slot.correct { color: #4ade80; border-color: #4ade80; }
        .slot.wrong { color: #ef4444; border-color: #ef4444; }
        
        .key-btn { 
            background: #111; border: 1px solid #333; color: #e2e8f0; border-radius: 6px; 
            font-weight: bold; font-size: 1rem; padding: 12px 0; touch-action: manipulation;
            transition: background 0.1s;
        }
        .key-btn:active { background: #333; transform: translateY(1px); }

        /* ANIMATIONS */
        @keyframes slideIn { from { transform: translateY(15px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
        .card-enter { animation: slideIn 0.25s ease-out; }
        .shake { animation: shake 0.3s cubic-bezier(.36,.07,.19,.97) both; }
        @keyframes shake { 10%, 90% { transform: translate3d(-1px, 0, 0); } 20%, 80% { transform: translate3d(2px, 0, 0); } 30%, 50%, 70% { transform: translate3d(-4px, 0, 0); } 40%, 60% { transform: translate3d(4px, 0, 0); } }
    </style>
</head>
<body>

    <!-- 1. HOME SCREEN -->
    <div id="main-menu" class="app-section active p-6 items-center justify-center bg-slate-950 relative">
        <div class="text-center mb-10 z-10 w-full max-w-sm">
            <h1 class="text-3xl font-black mb-1 tracking-tighter text-white">TRAFFIC<span class="text-blue-600">MASTER</span></h1>
            <p class="text-[10px] text-slate-500 uppercase tracking-[0.3em] font-bold mb-6">Text Only Edition</p>
            
            <!-- Stats Widget -->
            <div class="grid grid-cols-2 gap-2 mb-8">
                <div class="bg-slate-900 p-3 rounded-xl border border-slate-800">
                    <div class="text-[10px] text-slate-500 uppercase font-bold">Argomenti</div>
                    <div class="text-xl font-bold text-white" id="stat-topics">0</div>
                </div>
                <div class="bg-slate-900 p-3 rounded-xl border border-slate-800">
                    <div class="text-[10px] text-slate-500 uppercase font-bold">Lezioni</div>
                    <div class="text-xl font-bold text-white" id="stat-lessons">0</div>
                </div>
                <div class="bg-slate-900 p-2 rounded-xl border border-slate-800 col-span-2 flex justify-between items-center px-4">
                    <span class="text-[10px] text-slate-500 uppercase font-bold">Database Totale</span>
                    <span class="text-sm font-bold text-blue-400" id="stat-total">Caricamento...</span>
                </div>
            </div>
        </div>

        <div class="w-full max-w-sm space-y-4 z-10">
            <!-- Quiz Hacker -->
            <div onclick="openSelection('hacker')" class="menu-card bg-slate-900 rounded-2xl p-5 hover:border-blue-600 group">
                <div class="flex items-center gap-4">
                    <div class="bg-blue-600/20 w-10 h-10 rounded-lg flex items-center justify-center text-blue-500 text-lg">
                        <i class="fas fa-bolt"></i>
                    </div>
                    <div>
                        <h2 class="text-lg font-bold text-white group-hover:text-blue-400 transition-colors">Quiz Hacker</h2>
                        <span class="text-[10px] font-bold text-slate-500 uppercase">Allenamento Rapido</span>
                    </div>
                </div>
            </div>

            <!-- Code Breaker -->
            <div onclick="openSelection('breaker')" class="menu-card bg-black rounded-2xl p-5 border-green-900/30 hover:border-green-500 group">
                <div class="flex items-center gap-4">
                    <div class="bg-green-600/20 w-10 h-10 rounded-lg flex items-center justify-center text-green-500 text-lg">
                        <i class="fas fa-terminal"></i>
                    </div>
                    <div>
                        <h2 class="text-lg font-bold text-green-400 font-mono">Code Breaker</h2>
                        <span class="text-[10px] font-bold text-green-700 uppercase font-mono">Focus Training</span>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- 2. CONFIGURATION SCREEN -->
    <div id="selection-screen" class="app-section p-4 bg-slate-950">
        <div class="w-full max-w-md mx-auto h-full flex flex-col">
            
            <div class="flex justify-between items-center mb-6 pt-2">
                <button onclick="switchApp('menu')" class="text-slate-400 hover:text-white flex items-center gap-2 text-xs font-bold uppercase tracking-wider">
                    <i class="fas fa-chevron-left"></i> Home
                </button>
                <div class="text-xs font-black text-blue-500 uppercase tracking-widest">Configurazione</div>
            </div>

            <!-- Mode Tabs -->
            <div class="flex bg-slate-900 p-1 rounded-xl mb-4 border border-slate-800">
                <button onclick="setFilterMode('topic')" id="btn-mode-topic" class="flex-1 py-2.5 rounded-lg text-[10px] font-bold transition-all uppercase tracking-wide">
                    Per Argomento
                </button>
                <button onclick="setFilterMode('lesson')" id="btn-mode-lesson" class="flex-1 py-2.5 rounded-lg text-[10px] font-bold transition-all uppercase tracking-wide">
                    Per Lezione
                </button>
            </div>

            <div class="flex justify-between items-end mb-2 px-1">
                <span class="text-[10px] font-bold text-slate-500 uppercase">Seleziona Filtri</span>
                <span class="text-[10px] font-bold text-blue-400 cursor-pointer hover:text-white" onclick="toggleAllFilters()">Seleziona Tutti</span>
            </div>

            <!-- Scrollable List -->
            <div class="flex-1 overflow-y-auto pr-1 mb-4 space-y-1" id="filter-list">
                <!-- Filters injected here -->
            </div>

            <!-- Launch Button -->
            <button onclick="launchGame()" class="w-full py-4 bg-blue-600 rounded-xl font-black text-white uppercase tracking-widest hover:bg-blue-500 active:scale-95 transition-all shadow-lg shadow-blue-900/50 mb-4 flex items-center justify-center gap-2">
                <span>Avvia Sessione</span>
                <span id="selected-count-badge" class="bg-blue-800 text-[10px] px-2 py-0.5 rounded-full">0</span>
            </button>
        </div>
    </div>

    <!-- 3. GAME: QUIZ HACKER -->
    <div id="app-hacker" class="app-section p-4 bg-slate-900">
        <div class="flex flex-col h-full max-w-md mx-auto w-full relative">
            
            <div class="flex justify-between items-center py-4">
                <button onclick="openSelection('hacker')" class="text-slate-500 hover:text-white bg-slate-800/50 px-3 py-1.5 rounded-lg text-[10px] font-bold uppercase tracking-wider border border-slate-700">
                    <i class="fas fa-sliders mr-1"></i> Filtri
                </button>
                <div class="flex gap-1 text-red-500 text-sm" id="qh-lives">
                    <i class="fas fa-heart"></i><i class="fas fa-heart"></i><i class="fas fa-heart"></i>
                </div>
            </div>

            <div class="flex-1 flex flex-col justify-center pb-6">
                <!-- Card -->
                <div id="qh-card" class="bg-slate-800 w-full rounded-2xl p-8 shadow-2xl border-t border-slate-700 flex flex-col items-center justify-center min-h-[300px]">
                    
                    <div class="w-full flex justify-center mb-6">
                        <span id="qh-topic" class="text-[9px] font-bold uppercase tracking-widest text-blue-300 bg-blue-950 px-3 py-1 rounded-full border border-blue-900/50 max-w-full truncate">
                            ARGOMENTO
                        </span>
                    </div>

                    <div id="qh-text-container" class="text-center w-full break-words">
                        <!-- Content -->
                    </div>

                </div>
            </div>

            <!-- Controls -->
            <div class="grid grid-cols-2 gap-4 pb-8 h-[140px]">
                <button onclick="qh_answer(false)" class="bg-slate-800 border-b-4 border-red-900 text-red-500 rounded-xl font-black text-2xl active:border-b-0 active:translate-y-1 transition-all hover:bg-slate-750">FALSO</button>
                <button onclick="qh_answer(true)" class="bg-slate-800 border-b-4 border-green-900 text-green-500 rounded-xl font-black text-2xl active:border-b-0 active:translate-y-1 transition-all hover:bg-slate-750">VERO</button>
            </div>

            <!-- Feedback -->
            <div id="qh-feedback" class="absolute inset-0 hidden items-center justify-center z-50 bg-black/80 backdrop-blur-sm pointer-events-none transition-opacity">
                <div id="qh-feedback-icon" class="text-9xl transform scale-0 transition-transform duration-200 drop-shadow-2xl"></div>
            </div>
        </div>
    </div>

    <!-- 4. GAME: CODE BREAKER -->
    <div id="app-breaker" class="app-section breaker-font bg-black">
        <div class="flex flex-col h-full max-w-md mx-auto w-full relative">
            
            <div class="flex justify-between items-center p-4">
                <button onclick="openSelection('breaker')" class="text-green-800 hover:text-green-500 border border-green-900 px-3 py-1 rounded text-[10px] font-bold uppercase tracking-wider">
                    Esci
                </button>
                <div class="text-[10px] text-green-900 font-bold uppercase tracking-widest">Livello <span id="cb-lvl" class="text-green-500 text-base ml-1">1</span></div>
            </div>

            <div class="flex-1 flex flex-col justify-center items-center px-4 overflow-y-auto">
                
                <div id="cb-topic" class="text-[9px] text-green-700 border border-green-900/30 px-2 py-1 rounded mb-8 uppercase tracking-widest">TOPIC</div>
                
                <div id="cb-question-text" class="text-center mb-8 w-full">
                    <!-- Injected -->
                </div>

                <div id="cb-slots" class="flex flex-wrap justify-center gap-1 mb-4 w-full px-2">
                    <!-- Slots -->
                </div>
                
            </div>

            <!-- Keyboard -->
            <div class="bg-black p-2 pb-6 border-t border-green-900/20">
                <div id="cb-keys" class="grid grid-cols-7 gap-1.5 mb-3 max-w-sm mx-auto">
                    <!-- Keys -->
                </div>
                <div class="flex gap-2 max-w-sm mx-auto">
                    <button onclick="cb_delete()" class="flex-1 h-12 bg-slate-900 rounded border border-slate-800 text-red-500 active:bg-slate-800 font-bold flex items-center justify-center text-lg"><i class="fas fa-backspace"></i></button>
                    <button onclick="cb_check()" class="flex-[2] h-12 bg-green-900/20 text-green-400 border border-green-600 rounded font-bold hover:bg-green-900/40 active:scale-95 transition-all uppercase tracking-widest text-sm">INVIA</button>
                </div>
            </div>

        </div>
    </div>

    <!-- LOGIC -->
    <script>
        // --- DATA INJECTION (COPIA-INCOLLA DEL FILE UFFICIALE) ---
        // Questo è il contenitore dove il sistema inietta il testo grezzo del file allegato.
        const rawData = `
Lezione: 01.1 Definizioni stradali e di traffico
Argomento: La strada
La strada è...
[ F ] ...riservata alla circolazione dei soli autoveicoli e motocicli
[ V ] ...aperta alla circolazione dei pedoni, degli animali e dei veicoli
[ F ] ...qualsiasi area asfaltata, limitata lateralmente dagli attraversamenti pedonali
La strada può...
[ V ] ...comprendere le piste ciclabili
[ V ] ...essere suddivisa in carreggiate
[ V ] ...essere a doppio senso di circolazione
[ V ] ...essere a senso unico di circolazione
La strada non comprende...
[ F ] ...i marciapiedi
[ F ] ...le banchine
Argomento: La carreggiata
La carreggiata è...
[ F ] ...destinata soltanto alla circolazione di carri a trazione animale
[ V ] ...la parte della strada destinata normalmente alla circolazione dei veicoli
[ F ] ...destinata alla sosta degli autocarri
[ F ] ...la traccia lasciata dalle ruote dei veicoli sulle strade innevate
[ F ] ...destinata alla sosta di emergenza
La carreggiata può...
[ V ] ...essere a senso unico di circolazione
[ V ] ...essere suddivisa in corsie
[ V ] ...essere a doppio senso di circolazione
Fanno parte della carreggiata...
[ V ] ...le corsie di sorpasso
[ V ] ...le corsie di marcia
[ V ] ...gli attraversamenti pedonali
[ V ] ...gli attraversamenti ciclabili
Non fanno parte della carreggiata...
[ V ] ...le banchine
[ V ] ...i marciapiedi
[ V ] ...le piste ciclabili
[ V ] ...le piazzole di sosta
Le corsie...
[ V ] ...possono essere vietate a taluni tipi di veicoli
[ V ] ...possono essere destinate alla normale marcia dei veicoli
[ V ] ...possono essere destinate ai rallentamenti dei veicoli in uscita dalle autostrade
[ V ] ...possono essere riservate alla circolazione di alcune categorie di veicoli (taxi, autobus, ecc.)
[ V ] ...possono essere destinate alle accelerazioni dei veicoli in entrata nelle autostrade
[ V ] ...possono essere destinate al sorpasso
[ F ] ...possono essere a doppio senso di circolazione
[ F ] ...sono sempre delimitate da strisce continue
[ F ] ...formano la carreggiata solo se sono più di due
Argomento: Segnaletica
Il segnale raffigurato preannuncia...
[ V ] ...un tratto di strada deformata
[ V ] ...una strada in cattivo stato
[ V ] ...una variazione di pendenza
[ V ] ...un dosso artificiale
[ V ] ...una curva pericolosa a destra
[ V ] ...un passaggio a livello senza barriere
[ F ] ...un divieto di sosta
[ F ] ...un senso unico alternato
Il segnale raffigurato vieta...
[ V ] ...il transito a tutti i veicoli
[ V ] ...il sorpasso
[ V ] ...la sosta
[ V ] ...l'accesso
[ F ] ...la fermata
[ F ] ...di svoltare a destra
Argomento: Norme di Comportamento
Il conducente deve...
[ V ] ...regolare la velocità in relazione alle condizioni della strada
[ V ] ...dare la precedenza a destra negli incroci non regolati
[ V ] ...usare il casco se guida un motociclo
[ V ] ...fermarsi al semaforo rosso
[ F ] ...passare per primo sempre
[ F ] ...suonare il clacson in centro abitato
È vietato...
[ V ] ...sorpassare in curva
[ V ] ...invertire la marcia in autostrada
[ V ] ...guidare dopo aver assunto alcol
[ V ] ...gareggiare in velocità
[ F ] ...sorpassare di notte
[ F ] ...guidare con gli occhiali da sole
Lezione: 02.1 Veicoli
Argomento: Ciclomotori e Motocicli
I ciclomotori...
[ V ] ...hanno cilindrata fino a 50 cm3
[ V ] ...sviluppano una velocità massima di 45 km/h
[ F ] ...possono circolare in autostrada
[ F ] ...non hanno bisogno di assicurazione
La patente B...
[ V ] ...abilita a guidare le autovetture
[ V ] ...vale 10 anni fino ai 50 anni di età
[ F ] ...abilita a guidare gli autobus
`;

        // --- STATE ---
        let db = [];
        let topics = {}; // Map Name -> Count
        let lessons = {}; // Map Name -> Count
        let filterMode = 'topic'; // 'topic' or 'lesson'
        let selectedSet = new Set();
        let targetApp = '';

        // --- PARSER ---
        function parseAndInit() {
            const lines = rawData.split('\n');
            let curTopic = "Generale";
            let curLesson = "Non specificata";
            let curPrefix = "";
            let tempDB = [];

            lines.forEach(line => {
                line = line.trim();
                if (!line) return;

                // Headers
                if (line.startsWith("Argomento:")) {
                    curTopic = line.replace("Argomento:", "").trim();
                    return;
                }
                if (line.startsWith("Lezione:")) {
                    curLesson = line.replace("Lezione:", "").trim();
                    return;
                }

                // Questions
                if (line.startsWith("[ V ]") || line.startsWith("[ F ]")) {
                    const isTrue = line.startsWith("[ V ]");
                    let suffix = line.substring(5).trim();
                    if (suffix.startsWith("...")) suffix = suffix.substring(3).trim();
                    
                    let prefix = curPrefix;
                    if (prefix.endsWith("...")) prefix = prefix.substring(0, prefix.length - 3).trim();

                    tempDB.push({
                        text: `${prefix} ${suffix}`,
                        prefix: prefix,
                        suffix: suffix,
                        isTrue: isTrue,
                        topic: curTopic,
                        lesson: curLesson
                    });
                } else {
                    curPrefix = line;
                }
            });

            // Expand for demo purposes (simulate mass)
            for(let i=0; i<15; i++) {
                tempDB.forEach(q => db.push({...q}));
            }
            
            // Build Indexes
            db.forEach(q => {
                topics[q.topic] = (topics[q.topic] || 0) + 1;
                lessons[q.lesson] = (lessons[q.lesson] || 0) + 1;
            });

            // Update Dashboard
            document.getElementById('stat-total').innerText = db.length.toLocaleString();
            document.getElementById('stat-topics').innerText = Object.keys(topics).length;
            document.getElementById('stat-lessons').innerText = Object.keys(lessons).length;
            document.getElementById('total-count-display').innerText = `${db.length} QUIZ`;
        }

        // --- NAVIGATION ---
        function switchApp(id) {
            document.querySelectorAll('.app-section').forEach(el => el.classList.remove('active'));
            if(id === 'menu') document.getElementById('main-menu').classList.add('active');
            else if(id === 'hacker') { document.getElementById('app-hacker').classList.add('active'); initHacker(); }
            else if(id === 'breaker') { document.getElementById('app-breaker').classList.add('active'); initBreaker(); }
        }

        function openSelection(app) {
            targetApp = app;
            document.querySelectorAll('.app-section').forEach(el => el.classList.remove('active'));
            document.getElementById('selection-screen').classList.add('active');
            setFilterMode(filterMode); // Refresh
        }

        // --- FILTERS ---
        function setFilterMode(mode) {
            filterMode = mode;
            selectedSet = new Set(); // Reset on mode switch
            
            const btnT = document.getElementById('btn-mode-topic');
            const btnL = document.getElementById('btn-mode-lesson');
            
            if (mode === 'topic') {
                btnT.className = "flex-1 py-2.5 rounded-lg text-[10px] font-bold transition-all uppercase tracking-wide bg-blue-600 text-white shadow-lg";
                btnL.className = "flex-1 py-2.5 rounded-lg text-[10px] font-bold transition-all uppercase tracking-wide bg-slate-800 text-slate-400 hover:text-white";
                renderFilterList(topics);
            } else {
                btnL.className = "flex-1 py-2.5 rounded-lg text-[10px] font-bold transition-all uppercase tracking-wide bg-blue-600 text-white shadow-lg";
                btnT.className = "flex-1 py-2.5 rounded-lg text-[10px] font-bold transition-all uppercase tracking-wide bg-slate-800 text-slate-400 hover:text-white";
                renderFilterList(lessons);
            }
            updateBadge();
        }

        function renderFilterList(source) {
            const container = document.getElementById('filter-list');
            container.innerHTML = '';
            
            Object.keys(source).sort().forEach(key => {
                const div = document.createElement('div');
                div.className = 'filter-chip';
                div.innerHTML = `<span>${key}</span> <span class="filter-count">${source[key]}</span>`;
                div.onclick = () => toggleFilter(key, div);
                container.appendChild(div);
            });
        }

        function toggleFilter(key, el) {
            if (selectedSet.has(key)) {
                selectedSet.delete(key);
                el.classList.remove('selected');
            } else {
                selectedSet.add(key);
                el.classList.add('selected');
            }
            updateBadge();
        }

        function toggleAllFilters() {
            const items = filterMode === 'topic' ? Object.keys(topics) : Object.keys(lessons);
            const allSelected = items.every(k => selectedSet.has(k));
            
            if(allSelected) selectedSet.clear();
            else items.forEach(k => selectedSet.add(k));
            
            // Re-render to update visuals
            renderFilterList(filterMode === 'topic' ? topics : lessons);
            // Apply visual selection state manually to avoid loop flicker
            document.querySelectorAll('.filter-chip').forEach(el => {
                const key = el.querySelector('span').innerText;
                if(selectedSet.has(key)) el.classList.add('selected');
            });
            updateBadge();
        }

        function updateBadge() {
            const count = selectedSet.size;
            const badge = document.getElementById('selected-count-badge');
            badge.innerText = count === 0 ? "TUTTI" : count;
            badge.className = count === 0 ? "bg-slate-700 text-[10px] px-2 py-0.5 rounded-full" : "bg-white text-blue-600 font-bold text-[10px] px-2 py-0.5 rounded-full";
        }

        function getFilteredDB() {
            if (selectedSet.size === 0) return [...db].sort(() => Math.random() - 0.5);
            
            return db.filter(q => {
                const key = filterMode === 'topic' ? q.topic : q.lesson;
                return selectedSet.has(key);
            }).sort(() => Math.random() - 0.5);
        }

        function launchGame() {
            const pool = getFilteredDB();
            if (pool.length === 0) { alert("Nessun quiz disponibile per la selezione."); return; }
            
            if (targetApp === 'hacker') initHacker(pool);
            else initBreaker(pool);
            
            document.querySelectorAll('.app-section').forEach(el => el.classList.remove('active'));
            document.getElementById(targetApp === 'hacker' ? 'app-hacker' : 'app-breaker').classList.add('active');
        }

        // --- APP 1: QUIZ HACKER ---
        let qh_pool = [], qh_curr = null, qh_lives = 3, qh_score = 0;

        function initHacker(pool) {
            qh_pool = pool || getFilteredDB();
            qh_lives = 3; qh_score = 0;
            updateHackerLives();
            nextHacker();
        }

        function nextHacker() {
            if (qh_pool.length === 0) { alert("Sessione completata!"); switchApp('menu'); return; }
            qh_curr = qh_pool.pop();
            
            // Anim
            const card = document.getElementById('qh-card');
            card.classList.remove('card-enter', 'shake');
            void card.offsetWidth; card.classList.add('card-enter');

            document.getElementById('qh-topic').innerText = qh_curr.topic;
            document.getElementById('qh-text-container').innerHTML = `
                <span class="prefix-text">${qh_curr.prefix}</span>
                <span class="highlight-text">${qh_curr.suffix}</span>
            `;
        }

        function qh_answer(val) {
            const isCorrect = (val === qh_curr.isTrue);
            const fb = document.getElementById('qh-feedback');
            const icon = document.getElementById('qh-feedback-icon');
            
            fb.classList.remove('hidden'); fb.classList.add('flex');
            icon.innerHTML = isCorrect ? '<i class="fas fa-check text-green-500"></i>' : '<i class="fas fa-times text-red-500"></i>';
            icon.className = "text-8xl transform scale-150 transition-transform duration-200";

            if (isCorrect) qh_score += 10;
            else {
                qh_lives--;
                document.getElementById('qh-card').classList.add('shake');
            }
            updateHackerLives();

            setTimeout(() => {
                fb.classList.add('hidden'); fb.classList.remove('flex');
                if(qh_lives <= 0) { alert(`GAME OVER! Punti: ${qh_score}`); switchApp('menu'); }
                else nextHacker();
            }, 600);
        }

        function updateHackerLives() {
            let html = '';
            for(let i=0; i<3; i++) html += i < qh_lives ? '<i class="fas fa-heart"></i>' : '<i class="far fa-heart opacity-30"></i>';
            document.getElementById('qh-lives').innerHTML = html;
        }

        // --- APP 2: CODE BREAKER ---
        let cb_pool = [], cb_curr = null, cb_input = [], cb_word = "", cb_lvl = 1;

        function initBreaker(pool) {
            // Filter long enough TRUE questions
            cb_pool = (pool || getFilteredDB()).filter(q => q.isTrue && q.suffix.length > 8 && q.suffix.includes(" "));
            cb_lvl = 1;
            loadBreaker();
        }

        function loadBreaker() {
            if(cb_pool.length === 0) { alert("Sessione completata!"); switchApp('menu'); return; }
            cb_curr = cb_pool.pop();
            document.getElementById('cb-lvl').innerText = cb_lvl;
            document.getElementById('cb-topic').innerText = cb_curr.topic;

            // Pick word
            const words = cb_curr.suffix.split(' ').filter(w => w.length > 3);
            if(words.length === 0) { loadBreaker(); return; }
            const rawWord = words[Math.floor(Math.random() * words.length)];
            cb_word = rawWord.replace(/[^a-zA-Z]/g, "").toUpperCase();
            cb_input = Array(cb_word.length).fill('');

            const masked = cb_curr.suffix.replace(rawWord, '<span class="text-green-500 border-b-2 border-green-500 px-1 font-bold">?????</span>');
            
            document.getElementById('cb-question-text').innerHTML = `
                <span class="text-slate-500 block mb-2 font-medium">${cb_curr.prefix}</span>
                <span class="text-white text-lg font-bold">${masked}</span>
            `;

            // Slots
            const slots = document.getElementById('cb-slots');
            slots.innerHTML = '';
            for(let i=0; i<cb_word.length; i++) slots.innerHTML += `<div id="s${i}" class="slot"></div>`;
            highSlot(0);

            // Keys
            const keys = document.getElementById('cb-keys');
            keys.innerHTML = '';
            let poolL = cb_word.split('');
            const az = "ABCDEFGHIJKLMNOPQRSTUVWXYZ";
            for(let i=0; i<5; i++) poolL.push(az[Math.floor(Math.random()*az.length)]);
            poolL.sort(()=>Math.random()-0.5);
            poolL.forEach(c => {
                keys.innerHTML += `<button class="key-btn" onclick="typeC('${c}')">${c}</button>`;
            });
        }

        function typeC(c) {
            const i = cb_input.findIndex(x => x==='');
            if(i!==-1) { 
                cb_input[i]=c; 
                const el = document.getElementById(`s${i}`);
                el.innerText=c; el.classList.add('filled'); 
                highSlot(i+1); 
            }
        }

        function cb_delete() {
            let i = -1;
            for(let k=cb_input.length-1; k>=0; k--) if(cb_input[k]!==''){i=k;break;}
            if(i!==-1) { 
                cb_input[i]=''; 
                const el = document.getElementById(`s${i}`);
                el.innerText=''; el.classList.remove('filled','wrong'); 
                highSlot(i); 
            }
        }

        function highSlot(i) {
            document.querySelectorAll('.slot').forEach(e=>e.classList.remove('active'));
            const el=document.getElementById(`s${i}`); if(el) el.classList.add('active');
        }

        function cb_check() {
            if(cb_input.join('') === cb_word) {
                document.querySelectorAll('.slot').forEach(e=>e.classList.add('correct'));
                setTimeout(() => { cb_lvl++; loadBreaker(); }, 800);
            } else {
                const sl = document.getElementById('cb-slots');
                sl.classList.add('shake');
                document.querySelectorAll('.slot').forEach(e=>e.classList.add('wrong'));
                setTimeout(() => { 
                    sl.classList.remove('shake'); 
                    document.querySelectorAll('.slot').forEach(e=>e.classList.remove('wrong')); 
                }, 500);
            }
        }

        // START
        parseAndInit();

    </script>
</body>
</html>
