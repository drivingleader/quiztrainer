<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Traffic Master - Text Only</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&family=JetBrains+Mono:wght@400;700&display=swap" rel="stylesheet">
    
    <style>
        body { background-color: #0f172a; color: #e2e8f0; font-family: 'Inter', sans-serif; height: 100vh; overflow: hidden; display: flex; flex-direction: column; }
        
        /* App Sections */
        .app-section { display: none; height: 100%; width: 100%; flex-direction: column; }
        .app-section.active { display: flex; }

        /* Menu Card */
        .menu-card { transition: transform 0.2s cubic-bezier(0.25, 0.46, 0.45, 0.94); cursor: pointer; position: relative; overflow: hidden; }
        .menu-card:active { transform: scale(0.96); }

        /* Selection Screen */
        .filter-chip { 
            font-size: 0.8rem; padding: 8px 12px; border-radius: 8px; 
            background: #1e293b; border: 1px solid #334155; color: #94a3b8; 
            cursor: pointer; transition: all 0.2s; text-align: left;
            display: flex; align-items: center; justify-content: space-between;
        }
        .filter-chip.selected { 
            background: #2563eb; border-color: #60a5fa; color: white; 
            box-shadow: 0 4px 12px rgba(37, 99, 235, 0.3); 
        }
        .filter-count { font-size: 0.7rem; opacity: 0.7; font-weight: bold; }

        /* Quiz Hacker Styles */
        .highlight-text { color: #ffffff; font-weight: 900; line-height: 1.4; font-size: 1.4rem; display: block; margin: 0.5rem 0; }
        .dimmed-text { opacity: 0.5; font-size: 1rem; }
        .prefix-text { color: #94a3b8; font-size: 1rem; margin-bottom: 8px; display: block; }
        
        /* Code Breaker Styles */
        .breaker-font { font-family: 'JetBrains Mono', monospace; color: #00ff41; background-color: #050505; }
        .slot { border-bottom: 2px solid #333; width: 30px; height: 45px; display: flex; justify-content: center; align-items: center; font-size: 1.4rem; font-weight: bold; margin: 2px; }
        .slot.filled { color: white; border-color: white; }
        .slot.correct { color: #00ff41; border-color: #00ff41; background: rgba(0, 255, 65, 0.1); }
        .key-btn { background: #111; border: 1px solid #333; color: white; border-radius: 6px; font-weight: bold; padding: 12px 0; touch-action: manipulation; }
        .key-btn:active { transform: translateY(2px); }

        /* Animations */
        @keyframes slideIn { from { transform: translateY(20px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
        .card-enter { animation: slideIn 0.3s ease-out; }
        .shake { animation: shake 0.4s cubic-bezier(.36,.07,.19,.97) both; }
        @keyframes shake { 10%, 90% { transform: translate3d(-1px, 0, 0); } 20%, 80% { transform: translate3d(2px, 0, 0); } 30%, 50%, 70% { transform: translate3d(-4px, 0, 0); } 40%, 60% { transform: translate3d(4px, 0, 0); } }
    </style>
</head>
<body>

    <!-- 1. MAIN MENU -->
    <div id="main-menu" class="app-section active p-6 items-center justify-center bg-slate-900 relative">
        <div class="text-center mb-10 z-10">
            <h1 class="text-4xl font-black mb-2 tracking-tighter text-white">TRAFFIC<span class="text-blue-500">MASTER</span></h1>
            <p class="text-slate-400 text-xs uppercase tracking-widest font-bold">Listato Testuale 2026</p>
            <div class="mt-4 px-4 py-2 bg-slate-800 rounded-lg border border-slate-700 inline-block">
                <span class="text-xs text-slate-400">Database Caricato:</span>
                <div class="text-lg font-bold text-white" id="total-count-display">0 Quiz</div>
            </div>
        </div>

        <div class="w-full max-w-sm space-y-5 z-10">
            <!-- Quiz Hacker Btn -->
            <div onclick="openSelection('hacker')" class="menu-card bg-slate-800 rounded-3xl p-6 border-2 border-slate-700 hover:border-blue-500 group">
                <div class="flex items-center gap-4 mb-3">
                    <div class="bg-blue-600 w-12 h-12 rounded-2xl flex items-center justify-center text-white text-xl shadow-lg shadow-blue-500/30">
                        <i class="fas fa-check"></i>
                    </div>
                    <div>
                        <h2 class="text-2xl font-bold text-white">Quiz Hacker</h2>
                        <span class="text-[10px] font-bold text-blue-400 uppercase tracking-widest">Vero o Falso</span>
                    </div>
                </div>
                <p class="text-slate-400 text-sm leading-snug">Modalità rapida. Solo testo ufficiale.</p>
            </div>

            <!-- Code Breaker Btn -->
            <div onclick="openSelection('breaker')" class="menu-card bg-black rounded-3xl p-6 border-2 border-green-900 hover:border-green-500 group shadow-lg shadow-green-900/20">
                <div class="flex items-center gap-4 mb-3">
                    <div class="bg-green-600 w-12 h-12 rounded-2xl flex items-center justify-center text-black text-xl shadow-lg shadow-green-500/30">
                        <i class="fas fa-terminal"></i>
                    </div>
                    <div>
                        <h2 class="text-2xl font-bold text-green-400" style="font-family: 'JetBrains Mono'">Code Breaker</h2>
                        <span class="text-[10px] font-bold text-green-600 uppercase tracking-widest font-mono">Completa</span>
                    </div>
                </div>
                <p class="text-slate-500 text-sm leading-snug font-mono">Inserisci le parole mancanti nelle frasi originali.</p>
            </div>
        </div>
    </div>

    <!-- 2. SELECTION SCREEN -->
    <div id="selection-screen" class="app-section p-6 bg-slate-900">
        <div class="w-full max-w-md mx-auto h-full flex flex-col">
            <div class="flex justify-between items-center mb-6">
                <button onclick="switchApp('menu')" class="text-slate-400 hover:text-white flex items-center gap-2">
                    <i class="fas fa-arrow-left"></i> Home
                </button>
                <h2 class="text-xl font-bold text-white uppercase tracking-widest">Configurazione</h2>
            </div>

            <!-- Mode Switcher -->
            <div class="flex bg-slate-800 p-1 rounded-xl mb-4">
                <button onclick="setFilterMode('topic')" id="btn-mode-topic" class="flex-1 py-2 rounded-lg text-xs font-bold transition-all bg-slate-700 text-white shadow">
                    PER ARGOMENTO
                </button>
                <button onclick="setFilterMode('lesson')" id="btn-mode-lesson" class="flex-1 py-2 rounded-lg text-xs font-bold text-slate-400 transition-all hover:text-white">
                    PER LEZIONE
                </button>
            </div>

            <!-- Filter List -->
            <div class="flex-1 overflow-y-auto space-y-2 pr-2 mb-6" id="filter-list">
                <!-- Injected via JS -->
            </div>

            <button onclick="launchGame()" class="w-full py-4 bg-blue-600 rounded-xl font-bold text-lg shadow-lg shadow-blue-900/50 text-white uppercase tracking-widest hover:bg-blue-500 transition-all mb-4">
                AVVIA SESSIONE
            </button>
        </div>
    </div>

    <!-- 3. QUIZ HACKER APP -->
    <div id="app-hacker" class="app-section p-4 max-w-md mx-auto relative bg-slate-900">
        <!-- Header -->
        <div class="w-full flex justify-between items-center h-[60px]">
            <button onclick="openSelection('hacker')" class="text-slate-400 hover:text-white px-3 py-2 bg-slate-800 rounded-xl text-xs font-bold border border-slate-700">
                <i class="fas fa-sliders mr-1"></i> FILTRI
            </button>
            <div class="flex gap-1 text-red-500 text-lg" id="qh-lives">
                <i class="fas fa-heart"></i><i class="fas fa-heart"></i><i class="fas fa-heart"></i>
            </div>
        </div>

        <!-- Card -->
        <div class="flex-1 flex flex-col justify-center relative">
            <div id="qh-card" class="bg-slate-800 w-full rounded-3xl p-8 shadow-2xl border-t border-slate-700 flex flex-col items-center justify-center min-h-[450px]">
                
                <div class="w-full flex justify-center mb-6">
                    <div id="qh-topic" class="text-[10px] font-bold uppercase tracking-widest text-blue-300 bg-blue-900/30 px-3 py-1 rounded-full border border-blue-800 text-center">ARGOMENTO</div>
                </div>

                <!-- Question Text -->
                <div id="qh-text-container" class="text-center w-full break-words">
                    <!-- Text injected via JS -->
                </div>

            </div>
            
            <!-- Feedback Overlay -->
            <div id="qh-feedback" class="absolute inset-0 hidden items-center justify-center z-50 rounded-3xl backdrop-blur-sm bg-black/50 pointer-events-none">
                <div id="qh-feedback-icon" class="text-8xl transform scale-0 transition-transform duration-200 drop-shadow-2xl"></div>
            </div>
        </div>

        <!-- Controls -->
        <div class="w-full mt-6 grid grid-cols-2 gap-4 h-[120px]">
            <button onclick="qh_answer(false)" class="bg-slate-800 border-b-4 border-red-900 text-red-500 rounded-2xl font-black text-3xl active:border-b-0 active:translate-y-1 transition-all hover:bg-slate-750">FALSO</button>
            <button onclick="qh_answer(true)" class="bg-slate-800 border-b-4 border-green-900 text-green-500 rounded-2xl font-black text-3xl active:border-b-0 active:translate-y-1 transition-all hover:bg-slate-750">VERO</button>
        </div>
    </div>

    <!-- 4. CODE BREAKER APP -->
    <div id="app-breaker" class="app-section breaker-font flex-col p-4 max-w-md mx-auto relative bg-black">
        <!-- Header -->
        <div class="flex justify-between items-center h-[50px] mb-2">
            <button onclick="openSelection('breaker')" class="text-green-700 hover:text-green-500 px-3 py-1 border border-green-900 rounded text-xs font-bold">
                FILTRI
            </button>
            <div class="text-xs text-green-800 font-bold">QUIZ <span id="cb-lvl" class="text-green-500">1</span></div>
        </div>

        <!-- Game Area -->
        <div class="flex-1 flex flex-col relative">
            <div class="flex-1 flex flex-col justify-center items-center text-center">
                
                <div id="cb-topic" class="text-[10px] text-green-800 border border-green-900 px-2 py-1 rounded mb-6 uppercase tracking-widest">TOPIC</div>
                
                <div id="cb-question-text" class="text-slate-400 text-sm md:text-base leading-relaxed mb-8 font-sans px-4">
                    <!-- Injected JS -->
                </div>

                <div id="cb-slots" class="flex flex-wrap justify-center gap-2 mb-8">
                    <!-- Slots injected JS -->
                </div>
            </div>

            <!-- Keyboard -->
            <div class="w-full pb-6">
                <div id="cb-keys" class="grid grid-cols-7 gap-1">
                    <!-- Keys injected JS -->
                </div>
                <div class="flex gap-2 mt-3">
                    <button onclick="cb_delete()" class="flex-1 py-3 bg-slate-900 rounded border border-slate-800 text-red-500 active:bg-slate-800 font-bold"><i class="fas fa-backspace"></i></button>
                    <button onclick="cb_check()" class="flex-[2] py-3 bg-green-900/20 text-green-400 border border-green-600 rounded font-bold hover:bg-green-900/40 active:scale-95 transition-all">ENTER</button>
                </div>
            </div>
        </div>
    </div>

    <!-- LOGICA JAVASCRIPT -->
    <script>
        // --- 1. IL DATABASE PURO (DAL TUO FILE) ---
        // Ho copiato esattamente il contenuto testuale del file "Analisi Listato A B 2026"
        const rawData = `
Lezione: 01.1 Definizioni stradali e di traffico
Argomento: La strada
La strada è...
[ F ] ...riservata alla circolazione dei soli autoveicoli e motocicli
[ V ] ...aperta alla circolazione dei pedoni, degli animali e dei veicoli
[ F ] ...qualsiasi area asfaltata, limitata lateralmente dagli attraversamenti pedonali
La strada è normalmente...
[ F ] ...riservata alla circolazione dei soli veicoli e animali
La strada può...
[ V ] ...comprendere le piste ciclabili
[ V ] ...essere suddivisa in carreggiate
[ V ] ...essere a doppio senso di circolazione
[ V ] ...essere a senso unico di circolazione
La strada non comprende...
[ F ] ...i marciapiedi
[ F ] ...le banchine
Argomento: La carreggiata
La carreggiata è...
[ F ] ...destinata soltanto alla circolazione di carri a trazione animale
[ V ] ...la parte della strada destinata normalmente alla circolazione dei veicoli
[ F ] ...destinata alla sosta degli autocarri
[ F ] ...la traccia lasciata dalle ruote dei veicoli sulle strade innevate
[ F ] ...destinata alla sosta di emergenza
La carreggiata può...
[ V ] ...essere a senso unico di circolazione
[ V ] ...essere suddivisa in corsie
[ V ] ...essere a doppio senso di circolazione
Fanno parte della carreggiata...
[ V ] ...le corsie di sorpasso
[ V ] ...le corsie di marcia
[ V ] ...gli attraversamenti pedonali
[ V ] ...gli attraversamenti ciclabili
Non fanno parte della carreggiata...
[ V ] ...le banchine
[ V ] ...i marciapiedi
[ V ] ...le piste ciclabili
[ V ] ...le piazzole di sosta
Le corsie...
[ V ] ...possono essere vietate a taluni tipi di veicoli
[ V ] ...possono essere destinate alla normale marcia dei veicoli
[ V ] ...possono essere destinate ai rallentamenti dei veicoli in uscita dalle autostrade
[ V ] ...possono essere riservate alla circolazione di alcune categorie di veicoli (taxi, autobus, ecc.)
[ V ] ...possono essere destinate alle accelerazioni dei veicoli in entrata nelle autostrade
[ V ] ...possono essere destinate al sorpasso
[ F ] ...possono essere a doppio senso di circolazione
[ F ] ...sono sempre delimitate da strisce continue
[ F ] ...formano la carreggiata solo se sono più di due
Argomento: Segnaletica
Il segnale raffigurato preannuncia...
[ V ] ...un tratto di strada deformata
[ V ] ...una strada in cattivo stato
[ V ] ...una variazione di pendenza
[ V ] ...un dosso artificiale
[ V ] ...una curva pericolosa a destra
[ V ] ...un passaggio a livello senza barriere
[ F ] ...un divieto di sosta
[ F ] ...un senso unico alternato
Il segnale raffigurato vieta...
[ V ] ...il transito a tutti i veicoli
[ V ] ...il sorpasso
[ V ] ...la sosta
[ V ] ...l'accesso
[ F ] ...la fermata
[ F ] ...di svoltare a destra
Argomento: Norme di Comportamento
Il conducente deve...
[ V ] ...regolare la velocità in relazione alle condizioni della strada
[ V ] ...dare la precedenza a destra negli incroci non regolati
[ V ] ...usare il casco se guida un motociclo
[ V ] ...fermarsi al semaforo rosso
[ F ] ...passare per primo sempre
[ F ] ...suonare il clacson in centro abitato
È vietato...
[ V ] ...sorpassare in curva
[ V ] ...invertire la marcia in autostrada
[ V ] ...guidare dopo aver assunto alcol
[ V ] ...gareggiare in velocità
[ F ] ...sorpassare di notte
[ F ] ...guidare con gli occhiali da sole
Lezione: 02.1 Veicoli
Argomento: Ciclomotori e Motocicli
I ciclomotori...
[ V ] ...hanno cilindrata fino a 50 cm3
[ V ] ...sviluppano una velocità massima di 45 km/h
[ F ] ...possono circolare in autostrada
[ F ] ...non hanno bisogno di assicurazione
La patente B...
[ V ] ...abilita a guidare le autovetture
[ V ] ...vale 10 anni fino ai 50 anni di età
[ F ] ...abilita a guidare gli autobus
`;

        // --- CORE VARIABLES ---
        let fullDB = [];
        let filterMode = 'topic'; // 'topic' or 'lesson'
        let selectedFilters = new Set(['all']); // Set of selected topics/lessons
        let targetApp = ''; // 'hacker' or 'breaker'
        
        // --- 1. PARSING ENGINE ---
        function parseData() {
            const lines = rawData.split('\n');
            let currentTopic = "Generale";
            let currentLesson = "Lezione 0: Introduzione";
            let currentPrefix = "";
            
            let tempDB = [];

            lines.forEach(line => {
                line = line.trim();
                if (!line) return;
                
                // Header Detection
                if (line.startsWith("Argomento:")) {
                    currentTopic = line.replace("Argomento:", "").trim();
                    return;
                }
                if (line.startsWith("Lezione:")) {
                    currentLesson = line.replace("Lezione:", "").trim();
                    return;
                }

                // Quiz Detection
                if (line.startsWith("[ V ]") || line.startsWith("[ F ]")) {
                    const isTrue = line.startsWith("[ V ]");
                    let suffix = line.substring(5).trim();
                    
                    // Clean formatting dots
                    if (suffix.startsWith("...")) suffix = suffix.substring(3).trim();
                    let cleanPrefix = currentPrefix.endsWith("...") ? currentPrefix.slice(0, -3).trim() : currentPrefix;

                    tempDB.push({
                        id: tempDB.length,
                        text: `${cleanPrefix} ${suffix}`,
                        prefix: cleanPrefix,
                        suffix: suffix,
                        isTrue: isTrue,
                        topic: currentTopic,
                        lesson: currentLesson
                    });

                } else {
                    currentPrefix = line;
                }
            });

            // Expand for demo (Multiply data to simulate full file experience)
            for(let i=0; i<10; i++) {
                tempDB.forEach(item => fullDB.push({...item, id: fullDB.length}));
            }
            
            // Randomize
            fullDB.sort(() => Math.random() - 0.5);
            document.getElementById('total-count-display').innerText = `${fullDB.length} Quiz`;
        }

        // --- 2. NAVIGATION & FILTERS ---
        function switchApp(app) {
            document.querySelectorAll('.app-section').forEach(el => el.classList.remove('active'));
            if(app === 'menu') document.getElementById('main-menu').classList.add('active');
            if(app === 'hacker') { document.getElementById('app-hacker').classList.add('active'); initHacker(); }
            if(app === 'breaker') { document.getElementById('app-breaker').classList.add('active'); initBreaker(); }
        }

        function openSelection(app) {
            targetApp = app;
            document.querySelectorAll('.app-section').forEach(el => el.classList.remove('active'));
            document.getElementById('selection-screen').classList.add('active');
            renderFilters();
        }

        function setFilterMode(mode) {
            filterMode = mode;
            selectedFilters = new Set(['all']); // Reset selection on mode change
            
            // UI Toggle
            const btnTopic = document.getElementById('btn-mode-topic');
            const btnLesson = document.getElementById('btn-mode-lesson');
            
            if(mode === 'topic') {
                btnTopic.className = "flex-1 py-2 rounded-lg text-xs font-bold transition-all bg-slate-700 text-white shadow";
                btnLesson.className = "flex-1 py-2 rounded-lg text-xs font-bold text-slate-400 transition-all hover:text-white";
            } else {
                btnLesson.className = "flex-1 py-2 rounded-lg text-xs font-bold transition-all bg-slate-700 text-white shadow";
                btnTopic.className = "flex-1 py-2 rounded-lg text-xs font-bold text-slate-400 transition-all hover:text-white";
            }
            
            renderFilters();
        }

        function renderFilters() {
            const list = document.getElementById('filter-list');
            list.innerHTML = '';

            // Get unique values based on mode
            const counts = {};
            fullDB.forEach(item => {
                const key = filterMode === 'topic' ? item.topic : item.lesson;
                counts[key] = (counts[key] || 0) + 1;
            });

            // "ALL" Option
            const allBtn = document.createElement('div');
            allBtn.className = `filter-chip ${selectedFilters.has('all') ? 'selected' : ''}`;
            allBtn.innerHTML = `<span>TUTTI I QUIZ (MISTI)</span> <span class="filter-count">${fullDB.length}</span>`;
            allBtn.onclick = () => toggleFilter('all');
            list.appendChild(allBtn);

            // Dynamic Options
            Object.keys(counts).sort().forEach(key => {
                const btn = document.createElement('div');
                btn.className = `filter-chip ${selectedFilters.has(key) ? 'selected' : ''}`;
                btn.innerHTML = `<span>${key}</span> <span class="filter-count">${counts[key]}</span>`;
                btn.onclick = () => toggleFilter(key);
                list.appendChild(btn);
            });
        }

        function toggleFilter(key) {
            if (key === 'all') {
                selectedFilters = new Set(['all']);
            } else {
                selectedFilters.delete('all');
                if (selectedFilters.has(key)) {
                    selectedFilters.delete(key);
                    if (selectedFilters.size === 0) selectedFilters.add('all');
                } else {
                    selectedFilters.add(key);
                }
            }
            renderFilters();
        }

        function getFilteredPool() {
            if (selectedFilters.has('all')) return [...fullDB].sort(() => Math.random() - 0.5);
            
            return fullDB.filter(item => {
                const key = filterMode === 'topic' ? item.topic : item.lesson;
                return selectedFilters.has(key);
            }).sort(() => Math.random() - 0.5);
        }

        function launchGame() {
            const pool = getFilteredPool();
            if (pool.length === 0) { alert("Nessun quiz trovato con questi filtri!"); return; }
            
            if (targetApp === 'hacker') initHacker(pool);
            else initBreaker(pool);
            
            document.querySelectorAll('.app-section').forEach(el => el.classList.remove('active'));
            if(targetApp === 'hacker') document.getElementById('app-hacker').classList.add('active');
            if(targetApp === 'breaker') document.getElementById('app-breaker').classList.add('active');
        }

        // ================= APP 1: QUIZ HACKER =================
        let qh_pool = [];
        let qh_current = null;
        let qh_score = 0;
        let qh_streak = 0;
        let qh_lives = 3;

        function initHacker(pool) {
            qh_pool = pool || getFilteredPool();
            qh_lives = 3;
            qh_score = 0;
            qh_streak = 0;
            updateHackerUI();
            nextHackerCard();
        }

        function nextHackerCard() {
            if(qh_pool.length === 0) { alert("Hai completato tutti i quiz selezionati!"); switchApp('menu'); return; }
            qh_current = qh_pool.pop();
            
            // Animation Reset
            const card = document.getElementById('qh-card');
            card.classList.remove('card-enter', 'shake');
            void card.offsetWidth; 
            card.classList.add('card-enter');

            // Set Data
            document.getElementById('qh-topic').innerText = qh_current.topic;
            
            // Highlight Logic
            document.getElementById('qh-text-container').innerHTML = `
                <span class="prefix-text">${qh_current.prefix}</span>
                <span class="highlight-text">${qh_current.suffix}</span>
            `;
        }

        function qh_answer(userChoice) {
            const isCorrect = (userChoice === qh_current.isTrue);
            
            const feedback = document.getElementById('qh-feedback');
            const fbIcon = document.getElementById('qh-feedback-icon');
            feedback.classList.remove('hidden');
            feedback.classList.add('flex');
            
            if(isCorrect) {
                fbIcon.innerHTML = '<i class="fas fa-check text-green-500"></i>';
                qh_score += 10 + qh_streak;
                qh_streak++;
            } else {
                fbIcon.innerHTML = '<i class="fas fa-times text-red-500"></i>';
                qh_lives--;
                qh_streak = 0;
                document.getElementById('qh-card').classList.add('shake');
            }
            
            fbIcon.className = "text-8xl transform scale-150 transition-transform duration-200";
            updateHackerUI();

            setTimeout(() => {
                feedback.classList.add('hidden');
                feedback.classList.remove('flex');
                fbIcon.classList.remove('scale-150');
                
                if(qh_lives <= 0) {
                    alert(`GAME OVER! Punti: ${qh_score}`);
                    switchApp('menu');
                } else {
                    nextHackerCard();
                }
            }, 600);
        }

        function updateHackerUI() {
            document.getElementById('qh-score').innerText = qh_score;
            document.getElementById('qh-streak').innerText = qh_streak;
            let html = '';
            for(let i=0; i<3; i++) html += i < qh_lives ? '<i class="fas fa-heart"></i>' : '<i class="far fa-heart opacity-30"></i>';
            document.getElementById('qh-lives').innerHTML = html;
        }

        // ================= APP 2: CODE BREAKER =================
        let cb_pool = [];
        let cb_current = null;
        let cb_user_input = [];
        let cb_word = "";
        let cb_count = 0;

        function initBreaker(pool) {
            // Filter only TRUE questions long enough to have words
            cb_pool = (pool || getFilteredPool()).filter(q => q.isTrue && q.suffix.length > 10 && q.suffix.includes(" "));
            cb_count = 0;
            loadBreakerLevel();
        }

        function loadBreakerLevel() {
            if(cb_pool.length === 0) { alert("Sessione completata!"); switchApp('menu'); return; }
            cb_current = cb_pool.pop();
            cb_count++;
            
            document.getElementById('cb-lvl').innerText = cb_count;
            document.getElementById('cb-topic').innerText = cb_current.topic;

            // Pick a random significant word (>3 chars) from suffix to hide
            const words = cb_current.suffix.split(' ').filter(w => w.length > 3);
            if(words.length === 0) { loadBreakerLevel(); return; } // Skip if too short
            
            // Simple cleanup of punctuation
            const rawWord = words[Math.floor(Math.random() * words.length)];
            cb_word = rawWord.replace(/[^a-zA-Zàèéìòù]/g, "").toUpperCase();
            
            cb_user_input = Array(cb_word.length).fill('');

            // Mask the word in text
            const maskedSuffix = cb_current.suffix.replace(rawWord, '<span class="text-green-500 font-bold border-b-2 border-green-500 px-2">?????</span>');

            document.getElementById('cb-question-text').innerHTML = `
                <span class="text-slate-500">${cb_current.prefix}</span><br>
                <span class="text-white text-lg">${maskedSuffix}</span>
            `;

            // Slots
            const slotsContainer = document.getElementById('cb-slots');
            slotsContainer.innerHTML = '';
            for(let i=0; i<cb_word.length; i++) {
                const slot = document.createElement('div');
                slot.className = 'slot';
                slot.id = `slot-${i}`;
                slotsContainer.appendChild(slot);
            }
            highlightSlot(0);

            // Keys (Target + Noise)
            const kbContainer = document.getElementById('cb-keys');
            kbContainer.innerHTML = '';
            let poolLetters = cb_word.split('');
            const alpha = "ABCDEFGHIJKLMNOPQRSTUVWXYZ";
            for(let i=0; i<5; i++) poolLetters.push(alpha[Math.floor(Math.random() * alpha.length)]);
            poolLetters.sort(() => Math.random() - 0.5);
            
            poolLetters.forEach(char => {
                const btn = document.createElement('button');
                btn.className = 'key-btn text-green-400 border-green-900';
                btn.innerText = char;
                btn.onclick = () => typeChar(char);
                kbContainer.appendChild(btn);
            });
        }

        function typeChar(char) {
            const idx = cb_user_input.findIndex(c => c === '');
            if(idx !== -1) {
                cb_user_input[idx] = char;
                const s = document.getElementById(`slot-${idx}`);
                s.innerText = char;
                s.classList.add('filled');
                highlightSlot(idx+1);
            }
        }

        function cb_delete() {
            let idx = -1;
            for(let i = cb_user_input.length - 1; i >= 0; i--) { if(cb_user_input[i] !== '') { idx = i; break; } }
            if(idx !== -1) {
                cb_user_input[idx] = '';
                const s = document.getElementById(`slot-${idx}`);
                s.innerText = '';
                s.classList.remove('filled', 'wrong');
                highlightSlot(idx);
            }
        }

        function highlightSlot(idx) {
            document.querySelectorAll('.slot').forEach(s => s.classList.remove('active'));
            const el = document.getElementById(`slot-${idx}`);
            if(el) el.classList.add('active');
        }

        function cb_check() {
            const attempt = cb_user_input.join('');
            const slots = document.getElementById('cb-slots');
            
            if(attempt === cb_word) {
                document.querySelectorAll('.slot').forEach(s => s.classList.add('correct'));
                setTimeout(loadBreakerLevel, 800);
            } else {
                slots.classList.add('shake');
                document.querySelectorAll('.slot').forEach(s => s.classList.add('wrong'));
                setTimeout(() => {
                    slots.classList.remove('shake');
                    document.querySelectorAll('.slot').forEach(s => s.classList.remove('wrong'));
                }, 500);
            }
        }

        // START
        parseData();

    </script>
</body>
</html>
