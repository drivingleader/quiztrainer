<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Traffic Master Suite v4</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;700;900&family=JetBrains+Mono:wght@400;700&display=swap" rel="stylesheet">
    
    <style>
        /* --- GLOBAL STYLES --- */
        body {
            background-color: #0f172a;
            color: white;
            overflow: hidden;
            touch-action: manipulation;
            height: 100dvh;
            margin: 0;
            font-family: 'Inter', sans-serif;
        }

        /* --- APP SECTIONS --- */
        .app-section { display: none; height: 100%; width: 100%; flex-direction: column; }
        .app-section.active { display: flex; }

        /* --- MENU CARDS --- */
        .menu-card {
            transition: transform 0.2s cubic-bezier(0.25, 0.46, 0.45, 0.94);
        }
        .menu-card:active { transform: scale(0.96); }

        /* --- SELECTION GRID --- */
        .topic-btn {
            background: #1e293b;
            border: 2px solid #334155;
            border-radius: 12px;
            padding: 12px;
            text-align: center;
            font-weight: bold;
            font-size: 0.9rem;
            color: #94a3b8;
            transition: all 0.2s;
            cursor: pointer;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 5px;
        }
        .topic-btn.selected {
            background: #2563eb;
            border-color: #60a5fa;
            color: white;
            box-shadow: 0 0 15px rgba(37, 99, 235, 0.4);
        }
        .topic-btn i { font-size: 1.5rem; margin-bottom: 5px; }

        /* --- QUIZ HACKER STYLES --- */
        .hacker-font { font-family: 'Inter', sans-serif; }
        .gradient-text-hacker {
            background: linear-gradient(to right, #fbbf24, #d97706);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }
        .highlight-text { 
            color: #ffffff; 
            font-weight: 900; 
            line-height: 1.2; 
            text-shadow: 0 0 20px rgba(251, 191, 36, 0.2); 
            display: block; 
            margin: 0.5rem 0; 
            font-size: 1.3rem; 
        }
        .dimmed-text { opacity: 0.4; font-size: 0.95rem; }

        /* --- IMAGE HANDLING --- */
        .visual-area {
            width: 100%;
            height: 160px;
            background: #1e293b;
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            overflow: hidden;
            position: relative;
            border: 1px solid #334155;
            margin-bottom: 10px;
        }
        .ministerial-img {
            max-height: 100%;
            max-width: 100%;
            object-fit: contain;
        }
        
        /* --- CODE BREAKER STYLES --- */
        .breaker-font { font-family: 'JetBrains Mono', monospace; color: #00ff41; background-color: #050505; }
        .slot { border-bottom: 2px solid #333; transition: all 0.2s; }
        .slot.active { border-bottom-color: #00ff41; background: rgba(0, 255, 65, 0.1); }
        .slot.filled { border-bottom-color: white; color: white; }
        .slot.correct { border-bottom-color: #00ff41; color: #00ff41; background: rgba(0, 255, 65, 0.1); }
        .slot.wrong { border-bottom-color: #ef4444; color: #ef4444; }
        .key-btn { background: #111; border: 1px solid #333; color: white; border-radius: 8px; font-weight: bold; box-shadow: 0 4px 0 #000; }
        .key-btn:active { transform: translateY(4px); box-shadow: 0 0 0 #000; }

        /* --- ANIMATIONS --- */
        @keyframes slideIn { from { transform: translateY(30px) scale(0.95); opacity: 0; } to { transform: translateY(0) scale(1); opacity: 1; } }
        .card-enter { animation: slideIn 0.3s cubic-bezier(0.16, 1, 0.3, 1); }
        .shake { animation: shake 0.4s cubic-bezier(.36,.07,.19,.97) both; }
        @keyframes shake { 10%, 90% { transform: translate3d(-1px, 0, 0); } 20%, 80% { transform: translate3d(2px, 0, 0); } 30%, 50%, 70% { transform: translate3d(-4px, 0, 0); } 40%, 60% { transform: translate3d(4px, 0, 0); } }

        @media (max-height: 700px) {
            .visual-area { height: 120px; }
            .highlight-text { font-size: 1.1rem; }
            .topic-grid { grid-template-columns: repeat(2, 1fr); }
        }
    </style>
</head>
<body>

    <!-- ================= 1. MAIN MENU ================= -->
    <div id="main-menu" class="app-section active p-6 items-center justify-center font-sans bg-slate-900">
        <div class="text-center mb-8">
            <h1 class="text-4xl font-black mb-2 tracking-tighter">TRAFFIC<span class="text-blue-500">MASTER</span></h1>
            <p class="text-slate-400 text-xs uppercase tracking-widest">Training Ufficiale 2025</p>
        </div>

        <div class="w-full max-w-sm space-y-5">
            <!-- Quiz Hacker Btn -->
            <div onclick="openSelection('hacker')" class="menu-card bg-slate-800 rounded-3xl p-6 border-2 border-slate-700 hover:border-blue-500 cursor-pointer relative overflow-hidden group">
                <div class="absolute top-0 right-0 p-4 opacity-10 group-hover:opacity-20 transition-opacity">
                    <i class="fas fa-bolt text-9xl"></i>
                </div>
                <div class="relative z-10">
                    <div class="flex items-center gap-3 mb-2">
                        <div class="bg-blue-600 w-10 h-10 rounded-full flex items-center justify-center text-white">
                            <i class="fas fa-eye"></i>
                        </div>
                        <h2 class="text-2xl font-bold">Quiz Hacker</h2>
                    </div>
                    <p class="text-slate-400 text-sm mb-4">Focus 80/20. Immagini. Vero/Falso rapido.</p>
                </div>
            </div>

            <!-- Code Breaker Btn -->
            <div onclick="openSelection('breaker')" class="menu-card bg-black rounded-3xl p-6 border-2 border-green-900 hover:border-green-500 cursor-pointer relative overflow-hidden group shadow-lg shadow-green-900/20">
                <div class="absolute top-0 right-0 p-4 opacity-10 group-hover:opacity-20 transition-opacity">
                    <i class="fas fa-terminal text-9xl text-green-500"></i>
                </div>
                <div class="relative z-10">
                    <div class="flex items-center gap-3 mb-2">
                        <div class="bg-green-600 w-10 h-10 rounded-full flex items-center justify-center text-black">
                            <i class="fas fa-keyboard"></i>
                        </div>
                        <h2 class="text-2xl font-bold text-green-400" style="font-family: 'JetBrains Mono'">Code Breaker</h2>
                    </div>
                    <p class="text-slate-500 text-sm mb-4 font-mono">Completa le frasi mancanti.</p>
                </div>
            </div>
        </div>
        
        <div class="mt-8 text-center text-[10px] text-slate-500 bg-slate-800/50 p-2 rounded-lg border border-slate-700">
            <i class="fas fa-folder-open mr-1"></i> Carica le tue immagini nella cartella <strong>/img</strong><br>
            Rinominale come: <strong>1.jpg</strong>, <strong>402.png</strong>, ecc.
        </div>
    </div>

    <!-- ================= 2. SELECTION SCREEN (NEW) ================= -->
    <div id="selection-screen" class="app-section p-6 items-center justify-center bg-slate-900">
        <div class="w-full max-w-md flex flex-col h-full">
            <div class="flex justify-between items-center mb-6">
                <button onclick="goHome()" class="text-slate-400 hover:text-white"><i class="fas fa-arrow-left"></i> Home</button>
                <h2 class="text-xl font-bold text-white uppercase tracking-widest">Argomenti</h2>
            </div>

            <!-- Grid Selezione -->
            <div class="grid grid-cols-2 gap-3 mb-6 flex-1 overflow-y-auto content-start topic-grid">
                <div class="topic-btn selected w-full col-span-2 py-4" onclick="toggleTopic(this, 'all')">
                    <i class="fas fa-shuffle"></i>
                    MIX GENERALE
                    <span class="text-[10px] font-normal opacity-70">Tutto il listato</span>
                </div>
                
                <div class="topic-btn" onclick="toggleTopic(this, 'danger')">
                    <i class="fas fa-triangle-exclamation text-red-500"></i> Pericolo
                </div>
                <div class="topic-btn" onclick="toggleTopic(this, 'prohibition')">
                    <i class="fas fa-ban text-red-500"></i> Divieto
                </div>
                <div class="topic-btn" onclick="toggleTopic(this, 'obligation')">
                    <i class="fas fa-circle-exclamation text-blue-500"></i> Obbligo
                </div>
                <div class="topic-btn" onclick="toggleTopic(this, 'priority')">
                    <i class="fas fa-stop text-yellow-500"></i> Precedenza
                </div>
                <div class="topic-btn" onclick="toggleTopic(this, 'theory')">
                    <i class="fas fa-book text-green-500"></i> Definizioni
                </div>
                <div class="topic-btn" onclick="toggleTopic(this, 'behavior')">
                    <i class="fas fa-car-side text-purple-500"></i> Norme
                </div>
            </div>

            <button onclick="launchGame()" class="w-full py-4 bg-blue-600 rounded-xl font-bold text-lg shadow-lg shadow-blue-900/50 text-white uppercase tracking-widest hover:bg-blue-500 transition-all">
                AVVIA TRAINING >
            </button>
        </div>
    </div>

    <!-- ================= 3. APP: QUIZ HACKER ================= -->
    <div id="app-hacker" class="app-section hacker-font p-4 max-w-md mx-auto relative">
        <!-- Header -->
        <div class="w-full flex justify-between items-center z-10 pt-2 h-[50px] shrink-0">
            <button onclick="goHome()" class="text-slate-400 hover:text-white px-3 py-2 bg-slate-800 rounded-xl text-xs font-bold transition-colors border border-slate-700">
                <i class="fas fa-times mr-1"></i> ESCI
            </button>
            <div class="flex space-x-1 text-red-500 text-lg" id="qh-lives">
                <i class="fas fa-heart"></i><i class="fas fa-heart"></i><i class="fas fa-heart"></i>
            </div>
        </div>

        <!-- Card Area -->
        <div class="flex-1 w-full flex flex-col justify-center relative my-2 min-h-0">
            <div id="qh-card" class="bg-slate-800 w-full rounded-3xl p-6 shadow-2xl border-t border-slate-700 flex flex-col items-center justify-between h-full max-h-[600px]">
                
                <!-- Info Bar -->
                <div class="w-full flex justify-between items-center mb-2">
                    <div id="qh-badge-cat" class="text-[10px] font-bold uppercase tracking-widest text-blue-400">CATEGORIA</div>
                    <div id="qh-badge-fig" class="bg-slate-700 text-[10px] font-bold px-2 py-1 rounded text-slate-300 border border-slate-600">FIG. --</div>
                </div>

                <!-- VISUAL AREA -->
                <div class="visual-area">
                    <div id="qh-img-placeholder" class="text-slate-600 flex flex-col items-center gap-2">
                        <i class="fas fa-image text-2xl"></i>
                        <span class="text-[10px]">Cerca in /img/</span>
                    </div>
                    <img id="qh-img" class="ministerial-img" alt="Quiz Image" onerror="this.style.display='none'; document.getElementById('qh-img-placeholder').style.display='flex'">
                </div>

                <!-- Text -->
                <div id="qh-text" class="text-center w-full break-words flex-1 flex flex-col justify-center"></div>

                <!-- Progress -->
                <div class="w-full mt-4">
                    <div class="w-full h-1 bg-slate-700 rounded-full overflow-hidden">
                        <div id="qh-bar" class="h-full bg-yellow-500 w-0 transition-all duration-300"></div>
                    </div>
                </div>
            </div>
            
            <!-- Feedback Overlay -->
            <div id="qh-feedback" class="absolute inset-0 hidden items-center justify-center z-40 rounded-3xl backdrop-blur-md bg-black/60 pointer-events-none">
                <div id="qh-feedback-icon" class="text-9xl transform scale-0 transition-transform duration-200"></div>
            </div>
        </div>

        <!-- Controls -->
        <div class="w-full mt-2 grid grid-cols-2 gap-3 h-[100px] shrink-0">
            <button onclick="qh_answer(false)" class="bg-slate-800 border-b-4 border-red-900 text-red-500 rounded-2xl font-black text-2xl active:border-b-0 active:translate-y-1 transition-all hover:bg-slate-700">FALSO</button>
            <button onclick="qh_answer(true)" class="bg-slate-800 border-b-4 border-green-900 text-green-500 rounded-2xl font-black text-2xl active:border-b-0 active:translate-y-1 transition-all hover:bg-slate-700">VERO</button>
        </div>
    </div>

    <!-- ================= 4. APP: CODE BREAKER ================= -->
    <div id="app-breaker" class="app-section breaker-font flex-col p-4 max-w-md mx-auto relative bg-black">
        
        <!-- Header -->
        <div class="flex justify-between items-center z-10 h-[50px]">
            <button onclick="goHome()" class="text-green-700 hover:text-green-500 px-2 py-1 border border-green-900 rounded text-xs font-bold transition-colors">
                < ESCI
            </button>
            <div class="text-xs text-green-800 font-bold">LVL <span id="cb-lvl" class="text-green-500">1</span></div>
        </div>

        <!-- Game Area -->
        <div class="flex-1 flex flex-col px-2 pb-2 min-h-0 relative">
            <div class="flex-1 flex flex-col justify-center items-center">
                <div id="cb-cat-badge" class="mb-4 text-[10px] bg-green-900/30 text-green-400 px-2 py-1 rounded border border-green-800 uppercase">CAT</div>
                <div id="cb-question" class="text-center leading-relaxed text-slate-300 mb-6 font-bold text-lg font-sans"></div>
                <div id="cb-slots" class="flex flex-wrap justify-center gap-2 mb-8"></div>
            </div>

            <!-- Keyboard -->
            <div class="w-full pb-4">
                <div id="cb-msg" class="h-6 text-center text-xs uppercase tracking-widest mb-2 text-green-800 font-bold">Decripta il codice</div>
                <div id="cb-keys" class="grid grid-cols-7 gap-1.5"></div>
                <div class="flex gap-2 mt-3">
                    <button onclick="cb_delete()" class="flex-1 py-3 bg-slate-900 rounded border border-slate-800 text-red-500 active:bg-slate-800"><i class="fas fa-backspace"></i></button>
                    <button onclick="cb_check()" class="flex-[2] py-3 bg-green-900/30 text-green-400 border border-green-600 rounded font-bold hover:bg-green-600 hover:text-black transition-colors active:scale-95">ENTER</button>
                </div>
            </div>
        </div>
    </div>

    <!-- ================= JAVASCRIPT LOGIC ================= -->
    <script>
        // --- 0. CONFIGURAZIONE & DATABASE ---
        
        // Cerca immagini in ./img/N.jpg o .png (Locale)
        const IMG_PATH = "./img/"; 
        
        // --- DATABASE UFFICIALE MINISTERIALE (SAMPLE 80/20) ---
        // cat: danger, prohibition, obligation, priority, theory, behavior
        // fid: ID figura ufficiale (dal PDF)
        const full_db = [
            // PERICOLO (fig 1-35)
            { cat: 'danger', fid: '1', text: "Il segnale raffigurato preannuncia una strada deformata", isTrue: true, hl: "strada deformata" },
            { cat: 'danger', fid: '1', text: "Il segnale raffigurato preannuncia un tratto di strada in cattivo stato", isTrue: true, hl: "cattivo stato" },
            { cat: 'danger', fid: '1', text: "Il segnale raffigurato preannuncia una salita ripida", isTrue: false, hl: "salita ripida" },
            { cat: 'danger', fid: '2', text: "Il segnale raffigurato preannuncia un dosso", isTrue: true, hl: "dosso" },
            { cat: 'danger', fid: '2', text: "Il segnale raffigurato preannuncia una variazione di pendenza", isTrue: true, hl: "variazione di pendenza" },
            { cat: 'danger', fid: '3', text: "Il segnale raffigurato preannuncia una curva pericolosa a destra", isTrue: true, hl: "curva pericolosa a destra" },
            { cat: 'danger', fid: '4', text: "Il segnale raffigurato preannuncia una curva pericolosa a sinistra", isTrue: true, hl: "curva pericolosa a sinistra" },
            { cat: 'danger', fid: '7', text: "Il segnale raffigurato preannuncia una doppia curva, la prima a destra", isTrue: true, hl: "prima a destra" },
            { cat: 'danger', fid: '11', text: "Il segnale raffigurato preannuncia un passaggio a livello senza barriere", isTrue: true, hl: "senza barriere" },
            { cat: 'danger', fid: '11', text: "Il segnale raffigurato è integrato dal pannello distanziometrico a tre barre rosse", isTrue: true, hl: "tre barre rosse" },
            { cat: 'danger', fid: '13', text: "Il segnale raffigurato preannuncia un restringimento simmetrico della carreggiata", isTrue: true, hl: "restringimento simmetrico" },
            { cat: 'danger', fid: '24', text: "Il segnale raffigurato preannuncia luoghi frequentati da bambini", isTrue: true, hl: "frequentati da bambini" },
            { cat: 'danger', fid: '24', text: "Il segnale raffigurato indica la fine del divieto di sosta", isTrue: false, hl: "fine del divieto" },
            { cat: 'danger', fid: '33', text: "Il segnale raffigurato preannuncia lavori in corso", isTrue: true, hl: "lavori in corso" },
            
            // PRECEDENZA (fig 36-45)
            { cat: 'priority', fid: '36', text: "Il segnale raffigurato prescrive di dare precedenza ai veicoli provenienti sia da destra che da sinistra", isTrue: true, hl: "sia da destra che da sinistra" },
            { cat: 'priority', fid: '37', text: "Il segnale raffigurato obbliga a fermarsi in corrispondenza della striscia di arresto", isTrue: true, hl: "obbliga a fermarsi" },
            { cat: 'priority', fid: '37', text: "Il segnale raffigurato è un segnale di prescrizione", isTrue: true, hl: "prescrizione" },
            { cat: 'priority', fid: '37', text: "Il segnale raffigurato permette di passare senza fermarsi se non c'è nessuno", isTrue: false, hl: "senza fermarsi" },
            { cat: 'priority', fid: '40', text: "Il segnale raffigurato preannuncia un incrocio in cui vale la regola generale di dare la precedenza a destra", isTrue: true, hl: "precedenza a destra" },
            { cat: 'priority', fid: '41', text: "Il segnale raffigurato prescrive di dare precedenza nei sensi unici alternati", isTrue: true, hl: "sensi unici alternati" },
            { cat: 'priority', fid: '43', text: "Il segnale raffigurato indica l'inizio di una strada con diritto di precedenza", isTrue: true, hl: "diritto di precedenza" },
            
            // DIVIETO (fig 46-79)
            { cat: 'prohibition', fid: '46', text: "Il segnale raffigurato vieta il transito a tutti i veicoli", isTrue: true, hl: "vieta il transito" },
            { cat: 'prohibition', fid: '47', text: "Il segnale raffigurato vieta l'entrata ma non l'uscita (Senso Vietato)", isTrue: true, hl: "senso vietato" },
            { cat: 'prohibition', fid: '54', text: "Il segnale raffigurato vieta il sorpasso ai veicoli a motore", isTrue: true, hl: "vieta il sorpasso" },
            { cat: 'prohibition', fid: '54', text: "Il segnale raffigurato consente il sorpasso tra motocicli", isTrue: true, hl: "consente il sorpasso tra motocicli" },
            { cat: 'prohibition', fid: '61', text: "Il segnale raffigurato indica che non è consentito superare la velocità di 50 km/h", isTrue: true, hl: "non è consentito superare" },
            { cat: 'prohibition', fid: '61', text: "Il segnale raffigurato obbliga a marciare alla velocità di 50 km/h", isTrue: false, hl: "obbliga a marciare" },
            { cat: 'prohibition', fid: '76', text: "Il segnale raffigurato vieta la sosta ma consente la fermata", isTrue: true, hl: "consente la fermata" },
            { cat: 'prohibition', fid: '77', text: "Il segnale raffigurato vieta sia la sosta che la fermata", isTrue: true, hl: "sia la sosta che la fermata" },
            
            // OBBLIGO (fig 80-99)
            { cat: 'obligation', fid: '80a', text: "Il segnale raffigurato indica l'unica direzione consentita: dritto", isTrue: true, hl: "direzione consentita: dritto" },
            { cat: 'obligation', fid: '82b', text: "Il segnale raffigurato obbliga a svoltare a destra", isTrue: true, hl: "obbliga a svoltare" },
            { cat: 'obligation', fid: '84', text: "Il segnale raffigurato preannuncia una rotatoria", isTrue: true, hl: "rotatoria" },
            { cat: 'obligation', fid: '93', text: "Il segnale raffigurato impone un limite minimo di velocità", isTrue: true, hl: "limite minimo" },
            
            // TEORIA / DEFINIZIONI (No Immagine o generica)
            { cat: 'theory', fid: 'patente', text: "La patente B abilita a guidare le macchine agricole operatrici", isTrue: true, hl: "macchine agricole operatrici" },
            { cat: 'theory', fid: 'patente', text: "La patente B vale 10 anni fino ai 50 anni di età", isTrue: true, hl: "vale 10 anni" },
            { cat: 'theory', fid: 'veicoli', text: "I ciclomotori hanno cilindrata fino a 50 cm³", isTrue: true, hl: "fino a 50 cm³" },
            { cat: 'theory', fid: 'veicoli', text: "L'autovettura può trasportare al massimo 9 persone compreso il conducente", isTrue: true, hl: "massimo 9 persone" },
            { cat: 'theory', fid: 'norme', text: "La distanza di sicurezza deve essere almeno uguale allo spazio di reazione", isTrue: true, hl: "spazio di reazione" },
            
            // CODE BREAKER LEVELS (Fill Gap)
            { cat: 'cb_lvl', text: "STOP", pre: "Il segnale di STOP obbliga a", word: "FERMARSI", post: "alla striscia." },
            { cat: 'cb_lvl', text: "LIMITI", pre: "Il limite massimo in autostrada è", word: "130", post: "km/h." },
            { cat: 'cb_lvl', text: "PATENTE", pre: "La patente B vale", word: "DIECI", post: "anni." },
            { cat: 'cb_lvl', text: "SEGNALI", pre: "Il segnale triangolare con punta in alto indica", word: "PERICOLO", post: "." },
            { cat: 'cb_lvl', text: "NORME", pre: "È vietato il", word: "SORPASSO", post: "in curva." },
            { cat: 'cb_lvl', text: "LUCI", pre: "Le luci posteriori di posizione sono di colore", word: "ROSSO", post: "." }
        ];

        // --- GLOBAL VARIABLES ---
        let selectedApp = '';
        let selectedTopics = []; // ['danger', 'priority'] or ['all']
        let gamePool = [];
        let currentIndex = 0;
        let score = 0;
        let lives = 3;

        // --- NAVIGATION ---
        function openSelection(app) {
            selectedApp = app;
            document.querySelectorAll('.app-section').forEach(el => el.classList.remove('active'));
            document.getElementById('selection-screen').classList.add('active');
            
            // Reset selection
            selectedTopics = ['all'];
            updateTopicUI();
        }

        function goHome() {
            document.querySelectorAll('.app-section').forEach(el => el.classList.remove('active'));
            document.getElementById('main-menu').classList.add('active');
        }

        function toggleTopic(btn, topic) {
            const isAll = topic === 'all';
            
            if (isAll) {
                // If clicking ALL, clear others and set ALL
                selectedTopics = ['all'];
            } else {
                // If clicking specific
                if (selectedTopics.includes('all')) selectedTopics = []; // Remove ALL if active
                
                if (selectedTopics.includes(topic)) {
                    selectedTopics = selectedTopics.filter(t => t !== topic);
                } else {
                    selectedTopics.push(topic);
                }
                
                // If nothing selected, revert to ALL
                if (selectedTopics.length === 0) selectedTopics = ['all'];
            }
            updateTopicUI();
        }

        function updateTopicUI() {
            document.querySelectorAll('.topic-btn').forEach(btn => {
                const topic = btn.getAttribute('onclick').split("'")[1];
                if (selectedTopics.includes(topic)) {
                    btn.classList.add('selected');
                } else {
                    btn.classList.remove('selected');
                }
            });
        }

        function launchGame() {
            document.querySelectorAll('.app-section').forEach(el => el.classList.remove('active'));
            
            // Build Pool
            let source = full_db;
            if (selectedApp === 'breaker') {
                source = full_db.filter(item => item.cat === 'cb_lvl');
            } else {
                source = full_db.filter(item => item.cat !== 'cb_lvl'); // Exclude breaker levels for Hacker
                if (!selectedTopics.includes('all')) {
                    source = source.filter(item => selectedTopics.includes(item.cat));
                }
            }

            // Shuffle (Fisher-Yates)
            gamePool = [...source];
            for (let i = gamePool.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [gamePool[i], gamePool[j]] = [gamePool[j], gamePool[i]];
            }

            if (gamePool.length === 0) {
                alert("Nessun quiz trovato per questa selezione!");
                goHome();
                return;
            }

            if (selectedApp === 'hacker') startHacker();
            else startBreaker();
        }

        // ================= APP 1: HACKER LOGIC =================
        function startHacker() {
            document.getElementById('app-hacker').classList.add('active');
            lives = 3;
            score = 0;
            currentIndex = 0;
            updateHackerLives();
            loadHackerCard();
        }

        function loadHackerCard() {
            if (currentIndex >= gamePool.length) {
                alert("Sessione Completata! Ottimo lavoro.");
                goHome();
                return;
            }

            const q = gamePool[currentIndex];
            const card = document.getElementById('qh-card');
            
            // Reset Animation
            card.classList.remove('card-enter', 'shake');
            void card.offsetWidth; 
            card.classList.add('card-enter');

            // Set Badges
            document.getElementById('qh-badge-cat').innerText = getCatLabel(q.cat);
            document.getElementById('qh-badge-fig').innerText = isNaN(q.fid) ? "TEORIA" : `FIG. ${q.fid}`;

            // Image Logic
            const img = document.getElementById('qh-img');
            const placeholder = document.getElementById('qh-img-placeholder');
            
            img.style.display = 'none';
            placeholder.style.display = 'flex';
            
            if (!isNaN(q.fid)) {
                // Try .png, if fails try .jpg (browser handles file type somewhat, but explicit paths are safer. 
                // We'll try one standard extension. User instructed to use .jpg or .png)
                // Let's rely on onerror to show placeholder
                img.src = `${IMG_PATH}${q.fid}.png`; // Primary attempt
                img.style.display = 'block';
                placeholder.style.display = 'none';
            }

            // Text Highlight
            const container = document.getElementById('qh-text');
            if (q.text.toLowerCase().includes(q.hl)) {
                const parts = q.text.split(q.hl);
                container.innerHTML = `
                    <div class="dimmed-text">${parts[0]}</div>
                    <div class="highlight-text">${q.hl}</div>
                    <div class="dimmed-text">${parts[1]}</div>
                `;
            } else {
                container.innerHTML = `<div class="highlight-text">${q.text}</div>`;
            }

            // Progress
            const pct = ((currentIndex) / gamePool.length) * 100;
            document.getElementById('qh-bar').style.width = `${pct}%`;
        }

        function qh_answer(choice) {
            const q = gamePool[currentIndex];
            const isCorrect = (choice === q.isTrue);
            
            // Feedback
            const fb = document.getElementById('qh-feedback');
            const icon = document.getElementById('qh-feedback-icon');
            fb.classList.remove('hidden');
            fb.classList.add('flex');
            icon.innerHTML = isCorrect ? '<i class="fas fa-check text-green-500"></i>' : '<i class="fas fa-times text-red-500"></i>';
            icon.className = "text-9xl transform scale-150 transition-transform duration-200";

            if (!isCorrect) {
                lives--;
                updateHackerLives();
                if (lives <= 0) {
                    setTimeout(() => { alert("GAME OVER"); goHome(); }, 500);
                    return;
                }
            }

            setTimeout(() => {
                fb.classList.add('hidden');
                fb.classList.remove('flex');
                currentIndex++;
                loadHackerCard();
            }, 600);
        }

        function updateHackerLives() {
            let html = '';
            for(let i=0; i<3; i++) {
                html += i < lives ? '<i class="fas fa-heart"></i>' : '<i class="fas fa-heart-broken opacity-30"></i>';
            }
            document.getElementById('qh-lives').innerHTML = html;
        }

        function getCatLabel(cat) {
            const map = {
                'danger': 'PERICOLO', 'prohibition': 'DIVIETO', 'obligation': 'OBBLIGO',
                'priority': 'PRECEDENZA', 'theory': 'TEORIA', 'behavior': 'NORME'
            };
            return map[cat] || cat.toUpperCase();
        }

        // ================= APP 2: BREAKER LOGIC =================
        let cb_user = [];
        
        function startBreaker() {
            document.getElementById('app-breaker').classList.add('active');
            currentIndex = 0;
            loadBreakerLevel();
        }

        function loadBreakerLevel() {
            if (currentIndex >= gamePool.length) {
                alert("Tutti i codici decriptati!");
                goHome();
                return;
            }

            const q = gamePool[currentIndex];
            const word = q.word;
            cb_user = new Array(word.length).fill("");

            document.getElementById('cb-lvl').innerText = currentIndex + 1;
            document.getElementById('cb-cat-badge').innerText = q.text; // Using text field as Category/Hint here

            document.getElementById('cb-question').innerHTML = `
                <span class="opacity-70">${q.pre}</span><br>
                <span class="text-green-500 text-xs tracking-widest my-2 block">[ INSERIRE CODICE ]</span>
                <span class="opacity-70">${q.post}</span>
            `;

            // Slots
            const slots = document.getElementById('cb-slots');
            slots.innerHTML = '';
            for (let i = 0; i < word.length; i++) {
                const s = document.createElement('div');
                s.className = 'slot w-8 h-10 flex items-center justify-center text-lg font-bold bg-slate-900 mx-0.5 border border-slate-800';
                s.id = `slot-${i}`;
                slots.appendChild(s);
            }
            cb_highlight(0);

            // Keys
            const kb = document.getElementById('cb-keys');
            kb.innerHTML = '';
            let pool = word.split('');
            const alpha = "ABCDEFGHILMNOPQRSTUVZ0123456789";
            for(let n=0; n<4; n++) pool.push(alpha[Math.floor(Math.random()*alpha.length)]);
            pool.sort(() => Math.random()-0.5);
            
            pool.forEach(char => {
                const btn = document.createElement('button');
                btn.className = 'key-btn h-10 active:scale-95 text-green-400 border-green-900 hover:bg-green-900/50';
                btn.innerText = char;
                btn.onclick = () => cb_type(char);
                kb.appendChild(btn);
            });
        }

        function cb_type(char) {
            const idx = cb_user.findIndex(c => c === "");
            if (idx !== -1) {
                cb_user[idx] = char;
                document.getElementById(`slot-${idx}`).innerText = char;
                document.getElementById(`slot-${idx}`).classList.add('filled');
                cb_highlight(idx + 1);
            }
        }

        function cb_delete() {
            let idx = -1;
            for(let i=cb_user.length-1; i>=0; i--) if(cb_user[i]!=="") { idx=i; break; }
            if(idx !== -1) {
                cb_user[idx] = "";
                const s = document.getElementById(`slot-${idx}`);
                s.innerText = "";
                s.classList.remove('filled', 'wrong');
                cb_highlight(idx);
            }
        }

        function cb_highlight(idx) {
            document.querySelectorAll('.slot').forEach(s => s.classList.remove('active'));
            const el = document.getElementById(`slot-${idx}`);
            if (el) el.classList.add('active');
        }

        function cb_check() {
            const q = gamePool[currentIndex];
            const attempt = cb_user.join("");
            const container = document.getElementById('cb-slots');
            
            if (attempt === q.word) {
                document.querySelectorAll('.slot').forEach(s => s.classList.add('correct'));
                setTimeout(() => {
                    currentIndex++;
                    loadBreakerLevel();
                }, 1000);
            } else {
                container.classList.add('shake');
                document.querySelectorAll('.slot').forEach(s => s.classList.add('wrong'));
                setTimeout(() => {
                    container.classList.remove('shake');
                    document.querySelectorAll('.slot').forEach(s => s.classList.remove('wrong'));
                }, 500);
            }
        }

    </script>
</body>
</html>
